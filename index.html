<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sanya 2025 Wrapped</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@200..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div id="loader">
  <div id="loaderCard">
    <div id="loaderPercent"></div>
    <div id="loaderText"></div>
    <div class="loader-ring"></div>
  </div>
</div>

<div id="confetti"></div>

<div class="app">
  <div class="progress" id="progress" aria-hidden="true"></div>
  <div class="track" id="track" aria-live="polite"></div>

  <div class="hint">–°–≤–∞–π–ø ‚Üê ‚Üí –∏–ª–∏ —Å—Ç—Ä–µ–ª–∫–∏</div>
  <div class="dots" id="dots"></div>

  <div class="controls">
    <button class="btn" id="prev" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª–∞–π–¥">‚Üê</button>
    <button class="btn" id="next" aria-label="–°–ª–µ–¥—É—é—â–∏–π —Å–ª–∞–π–¥">‚Üí</button>
  </div>
</div>

<script>
(() => {
  const slides = [
    {pill:"Wrapped 2025",title:"–ò—Ç–æ–≥–∏",big:"2025",desc:"–ù–µ–º–Ω–æ–≥–æ —Ü–∏—Ñ—Ä –∏ –Ω–µ–º–Ω–æ–≥–æ —é–º–æ—Ä–∞."},
    {pill:"Wrapped 2025",title:"–ë—ç–º–±–∏ —Ç—è–≤–∫–Ω—É–ª–∞",big:"‚âà 5",desc:"–ù–æ –æ–Ω–∞ –≤—Å–µ —Ä–∞–≤–Ω–æ —Ç–µ–±—è –ª—é–±–∏—Ç –±–æ–ª—å—à–µ –≤—Å–µ—Ö."},
    {pill:"Wrapped 2025",title:"–°–ª–æ–≤–æ ¬´–∫_–∫_—Ç—å¬ª",big:"32 —Ä–∞–∑–∞",desc:"–ü–æ-—Ä–∞–∑–Ω–æ–º—É –∏ –∫–∞–∂–¥—ã–π –≤ —Å–≤–æ–µ –≤—Ä–µ–º—è."},
    {pill:"Wrapped 2025",title:"¬´–ß—Ç–æ –Ω–∞ —É–∂–∏–Ω?¬ª",big:"30 —Ä–∞–∑",desc:"–ì–ª–∞–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å –≥–æ–¥–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –º—ã –ø—ã—Ç–∞–ª–∏—Å—å –ø—Ä–∏–¥—É–º–∞—Ç—å –æ—Ç–≤–µ—Ç."},
    {pill:"Wrapped 2025",title:"¬´–Ø –≤—ã—à–µ–ª¬ª",big:"29 —Ä–∞–∑",desc:"–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ."},
    {pill:"Wrapped 2025",title:"¬´–ß–º–æ–∫¬ª",big:"398",desc:"–ü–æ—á—Ç–∏ 400 ‚Äî –Ω–æ —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã –±–æ–ª—å—à–µ. –¶–µ–ª—å –Ω–∞ 2026 —Ö3."},
    {pill:"Wrapped 2025",title:"–ü–æ–±—ã–≤–∞–ª–∏ –≤ –Ω–æ–≤—ã—Ö –º–µ—Å—Ç–∞—Ö",big:"2 —Ä–∞–∑–∞",desc:"–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ –∏ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥."},
    {pill:"Wrapped 2025",title:"–ü—Ä–æ–≤–µ–ª–∏ –Ω–æ–Ω-—Å—Ç–æ–ø",big:"7 200 –º–∏–Ω.",desc:"–ò –¥–∞–∂–µ –Ω–µ —Ä—É–≥–∞–ª–∏—Å—å!"},
    {pill:"Wrapped 2025",title:"–°–∞–º—ã–π —Å–ø–æ–∫–æ–π–Ω—ã–π –º–æ–º–µ–Ω—Ç",big:"–°–æ–Ω",desc:"–ö–æ–≥–¥–∞ —è –¥–æ—Å—Ç–∞—é —Ç–µ–±—è –Ω–æ–∂–∫–æ–π."},
    {pill:"Wrapped 2025",title:"–õ—É—á—à–µ–µ –∑–∞ –≥–æ–¥",big:"–¢—ã",desc:"–ü—É—Å—Ç—å 2026 –±—É–¥–µ—Ç –µ—â—ë –ª—É—á—à–µ. –Ø ‚ù§Ô∏è —Ç–µ–±—è!"}
  ];

  const app = document.querySelector(".app");
  const track = document.getElementById("track");
  const dots = document.getElementById("dots");
  const progress = document.getElementById("progress");

  const btnPrev = document.getElementById("prev");
  const btnNext = document.getElementById("next");

  let index = 0;

  // ===== Render slides =====
  slides.forEach((s, i) => {
    const slide = document.createElement("section");
    slide.className = "slide";
    slide.innerHTML = `
      <div class="card">
        <div class="card-inner">
          <div class="meta">
            <div class="pill">üéâ ${s.pill}</div>
            <div>${i + 1}/${slides.length}</div>
          </div>
          <h1 class="title">${s.title}</h1>
          <div class="big">${s.big}</div>
          <p class="desc">${s.desc}</p>
        </div>
      </div>
    `;
    track.appendChild(slide);

    const dot = document.createElement("button");
    dot.type = "button";
    dot.className = "dot";
    dot.setAttribute("aria-label", `–°–ª–∞–π–¥ ${i + 1}`);
    dot.addEventListener("click", () => go(i, { animate: true }));
    dots.appendChild(dot);
  });

  // ===== Progress segments =====
  const segs = [];
  slides.forEach((_, i) => {
    const seg = document.createElement("button");
    seg.type = "button";
    seg.className = "seg";
    seg.setAttribute("aria-label", `–°–ª–∞–π–¥ ${i + 1}`);
    seg.innerHTML = `<div class="fill"></div>`;
    seg.addEventListener("click", () => go(i, { animate: true }));
    progress.appendChild(seg);
    segs.push(seg);
  });

  function viewportWidth(){
    const vv = window.visualViewport;
    return vv ? vv.width : window.innerWidth;
  }

  function baseXForIndex(i, w){
    return -i * w;
  }

  function setTrackPx(px, animate){
    track.classList.toggle("no-anim", !animate);
    track.style.transform = `translate3d(${px}px,0,0)`;
  }

  function setActiveUI(dirClass){
    document.querySelectorAll(".slide").forEach((s, j) => {
      s.classList.remove("active", "from-right", "from-left");
      if (j === index) s.classList.add("active", dirClass);
    });

    document.querySelectorAll(".dot").forEach((d, j) => {
      d.classList.toggle("active", j === index);
      d.setAttribute("aria-current", j === index ? "true" : "false");
    });

    segs.forEach((seg, j) => {
      const fill = seg.querySelector(".fill");
      if (j < index) fill.style.transform = "scaleX(1)";
      else if (j > index) fill.style.transform = "scaleX(0)";
      else fill.style.transform = "scaleX(1)";
    });

    btnPrev.disabled = (index === 0);
    btnNext.disabled = (index === slides.length - 1);
  }

  function setProgressDuringDrag(dx, w){
    // dx < 0 => towards NEXT (index+1)
    // dx > 0 => towards PREV (index-1)
    const t = Math.min(1, Math.max(0, Math.abs(dx) / w));

    // base state
    segs.forEach((seg, j) => {
      const fill = seg.querySelector(".fill");
      if (j < index) fill.style.transform = "scaleX(1)";
      else if (j > index) fill.style.transform = "scaleX(0)";
      else fill.style.transform = "scaleX(1)";
    });

    const cur = segs[index]?.querySelector(".fill");
    if (!cur) return;

    if (dx < 0){
      const next = segs[index + 1]?.querySelector(".fill");
      if (!next) return;
      cur.style.transform = `scaleX(${1 - t})`;
      next.style.transform = `scaleX(${t})`;
    } else if (dx > 0){
      const prev = segs[index - 1]?.querySelector(".fill");
      if (!prev) return;
      // prev —É–∂–µ 1, current ‚Äú–ø—É—Å—Ç–µ–µ—Ç‚Äù
      cur.style.transform = `scaleX(${1 - t})`;
    }
  }

  function go(i, { animate = true } = {}){
    const prevIndex = index;
    index = Math.max(0, Math.min(slides.length - 1, i));

    const dir = index > prevIndex ? "from-right" : "from-left";
    const w = viewportWidth();

    setTrackPx(baseXForIndex(index, w), animate);
    setActiveUI(dir);
  }

  // ===== Controls =====
  btnNext.addEventListener("click", () => go(index + 1, { animate: true }));
  btnPrev.addEventListener("click", () => go(index - 1, { animate: true }));

  window.addEventListener("keydown", (e) => {
    if (e.key === "ArrowRight") go(index + 1, { animate: true });
    if (e.key === "ArrowLeft") go(index - 1, { animate: true });
  });

  // ===== Swipe (both directions) + iOS-safe width lock =====
  let isDragging = false;
  let startX = 0;
  let startY = 0;
  let startBase = 0;
  let dragW = 0;

  let lastX = 0;
  let lastT = 0;
  let vx = 0;

  let activePointerId = null;
  let axis = null; // "x" | "y" | null

  const AXIS_LOCK_PX = 10;

  function clampX(x){
    const min = baseXForIndex(slides.length - 1, dragW);
    const max = baseXForIndex(0, dragW);
    if (x < min) return min + (x - min) * 0.25;
    if (x > max) return max + (x - max) * 0.25;
    return x;
  }

  function resnapNow(){
    const w = viewportWidth();
    setTrackPx(baseXForIndex(index, w), false);
    setActiveUI("from-right");
  }

  function onDown(e){
    if (activePointerId !== null) return;
    if (e.pointerType === "mouse" && e.button !== 0) return;

    activePointerId = e.pointerId ?? "touch";
    isDragging = true;
    axis = null;

    dragW = viewportWidth(); // ‚úÖ —Ñ–∏–∫—Å–∏—Ä—É–µ–º —à–∏—Ä–∏–Ω—É –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –∂–µ—Å—Ç–∞
    startX = e.clientX;
    startY = e.clientY;
    startBase = baseXForIndex(index, dragW);

    lastX = e.clientX;
    lastT = performance.now();
    vx = 0;

    track.classList.add("no-anim");
  }

  function onMove(e){
    if (!isDragging) return;
    if (activePointerId !== e.pointerId) return;

    const dx = e.clientX - startX;
    const dy = e.clientY - startY;

    if (!axis){
      if (Math.abs(dx) < AXIS_LOCK_PX && Math.abs(dy) < AXIS_LOCK_PX) return;
      axis = Math.abs(dx) >= Math.abs(dy) ? "x" : "y";
      if (axis === "y"){
        // –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –∂–µ—Å—Ç ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º —Å–ª–∞–π–¥—ã
        isDragging = false;
        axis = null;
        activePointerId = null;
        track.classList.remove("no-anim");
        return;
      }
    }

    // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å: –º–æ–∂–Ω–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç
    e.preventDefault();

    const now = performance.now();
    const target = clampX(startBase + dx);

    setTrackPx(target, false);
    setProgressDuringDrag(dx, dragW);

    const dt = now - lastT;
    if (dt > 0){
      const v = (e.clientX - lastX) / dt; // px/ms
      vx = vx * 0.75 + v * 0.25;
      lastX = e.clientX;
      lastT = now;
    }
  }

  function onUp(e){
    if (!isDragging) return;
    if (activePointerId !== e.pointerId) return;

    isDragging = false;

    const dx = e.clientX - startX;

    const velocityThreshold = 0.6;      // px/ms
    const distanceThreshold = dragW * 0.18;

    let targetIndex = index;

    // –≤–ø—Ä–∞–≤–æ => –Ω–∞–∑–∞–¥
    if (dx > distanceThreshold || vx > velocityThreshold){
      targetIndex = index - 1;
    }
    // –≤–ª–µ–≤–æ => –≤–ø–µ—Ä—ë–¥
    if (dx < -distanceThreshold || vx < -velocityThreshold){
      targetIndex = index + 1;
    }

    targetIndex = Math.max(0, Math.min(slides.length - 1, targetIndex));

    track.classList.remove("no-anim");
    go(targetIndex, { animate: true });

    axis = null;
    activePointerId = null;
  }

  window.addEventListener("pointerdown", onDown, { passive: true });
  window.addEventListener("pointermove", onMove, { passive: false }); // –Ω—É–∂–Ω–æ –¥–ª—è preventDefault
  window.addEventListener("pointerup", onUp, { passive: true });
  window.addEventListener("pointercancel", onUp, { passive: true });

  // ===== iOS Safari: –∞–¥—Ä–µ—Å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞/viewport =====
  window.addEventListener("resize", resnapNow);
  if (window.visualViewport){
    window.visualViewport.addEventListener("resize", resnapNow);
    window.visualViewport.addEventListener("scroll", () => {
      // –∫–æ–≥–¥–∞ Safari –¥–≤–∏–≥–∞–µ—Ç viewport ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –¥–æ—Å–Ω–∞–ø–∏–º
      resnapNow();
    });
  }

  // ===== Init =====
  go(0, { animate: false });
  requestAnimationFrame(() => go(0, { animate: false }));
})();
</script>

<script>
  // PRELOADER (6s) + CONFETTI
  document.body.classList.add("is-loading");

  requestAnimationFrame(() => {
    setTimeout(() => {
      const loader = document.getElementById("loader");
      if (loader) loader.remove();
      document.body.classList.remove("is-loading");
      launchConfetti();
    }, 6000);
  });

  function launchConfetti(){
    const wrap = document.getElementById("confetti");
    if (!wrap) return;

    const colors = ["#e33025","#e05188","#f2cecb"];
    const pieces = 200;

    for (let i = 0; i < pieces; i++){
      const el = document.createElement("div");
      el.className = "confetti";
      el.style.left = (Math.random() * 100) + "vw";
      el.style.backgroundColor = colors[(Math.random() * colors.length) | 0];

      const dur = 2.2 + Math.random() * 2.3;
      const delay = Math.random() * 0.15;
      el.style.animationDuration = dur + "s";
      el.style.animationDelay = delay + "s";

      const rot = Math.random() * 360;
      const drift = (Math.random() * 160 - 80);
      el.style.transform = `translateX(${drift}px) rotate(${rot}deg)`;

      wrap.appendChild(el);
      setTimeout(() => el.remove(), (dur + delay) * 1000 + 200);
    }
  }
</script>

</body>
</html>
